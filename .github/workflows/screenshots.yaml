name: screenshots

on:
  workflow_run:
    workflows: ["Test and Build"]
    types: [completed]
  workflow_dispatch:

jobs:
  deploy-screenshots-branch:
    name: Deploy screenshots branch
    runs-on: ubuntu-latest
    # Only for PRs, and only if CI succeeded
    if: github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
      pull-requests: write
      actions: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0  # Need full history for git+file ref to master

      - name: Install Nix
        uses: cachix/install-nix-action@v24

      - name: Cachix
        uses: cachix/cachix-action@v12
        with:
          name: mdfried-ci
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Build screenshot diffs
        run: |
          REFERENCE=$(nix build "git+file://$PWD?ref=master#screenshots" --print-out-paths --impure)
          REFERENCE=$REFERENCE nix build .#screenshotDiffs --impure --print-build-logs
          cp -rL result pages

      - name: Download PR number artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: pr-number
          path: .
          github_token: ${{ github.token }}

      - name: Read PR number
        id: pr
        run: |
          PR_NUMBER=$(cat pr-number.txt)
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Deploy to external repo
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.SCREENSHOTS_PAT }}
          external_repository: benjajaja/mdfried-screenshots
          publish_dir: ./pages
          publish_branch: pr-${{ steps.pr.outputs.number }}
          force_orphan: true

      - name: Generate PR comment
        run: |
          PR_NUM="${{ steps.pr.outputs.number }}"
          BASE_URL="https://raw.githubusercontent.com/benjajaja/mdfried-screenshots/pr-${PR_NUM}"
          sed "s|IMAGE_BASE_URL|${BASE_URL}|g" pages/body.html > comment.html

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ steps.pr.outputs.number }}
          path: comment.html

  deploy-screenshots-master:
    name: Deploy master screenshots to external repo
    runs-on: ubuntu-latest
    # Only for push to master, and only if CI succeeded
    if: github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'master' && github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
      actions: read
    steps:
      - name: Download screenshots artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: screenshots
          path: pages
          github_token: ${{ github.token }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.SCREENSHOTS_PAT }}
          external_repository: benjajaja/mdfried-screenshots
          publish_dir: ./pages
          publish_branch: gh-pages
