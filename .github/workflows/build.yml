name: Test and Build

on:
  push:
    branches: [master]
  pull_request:
  workflow_dispatch:
  workflow_call:

jobs:
  nix-flake-test:
    name: Flake check ❄️
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24

      - name: Cachix
        uses: cachix/cachix-action@v12
        with:
          name: mdfried-ci
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Flake check
        run: |
          nix flake show
          nix flake check --print-build-logs

  nix-build:
    name: Nix build ❄️
    runs-on: ubuntu-latest
    outputs:
      artifact_path: ${{ steps.upload-artifact.outputs.artifact_path }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24

      - name: Cachix
        uses: cachix/cachix-action@v12
        with:
          name: mdfried-ci
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Build package
        run: |
          nix build . --print-build-logs

      - name: Patchelf
        run: |
          cp ./result/bin/mdfried .
          chmod u+w ./mdfried
          patchelf --set-interpreter /lib64/ld-linux-x86-64.so.2 mdfried

      - name: Test binary portability for Ubuntu 24.04
        run: |
          output=$(docker run --rm -v $(pwd):/work ubuntu:24.04 /work/mdfried --version)
          echo "Output: $output"
          if [[ "$output" =~ ^mdfried\ [0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "✅ Binary works on Ubuntu 24.04 - Version: $output"
          else
            echo "❌ Binary test failed! Expected format: 'mdfried x.y.z'"
            exit 1
          fi

      - name: Suffix binary artifact
        run: mv ./mdfried ./mdfried_nix_glibc_2_38

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mdfried-nix
          path: ./mdfried_nix_glibc_2_38

  cargo-build:
    name: Cargo build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            container: ubuntu:20.04
            artifact_name: mdfried-linux
            build_deb: true
          - os: macos-latest
            container: null
            artifact_name: mdfried_macos
            build_deb: false
    container: ${{ matrix.container }}
    outputs:
      artifact_path: ${{ steps.upload-artifact.outputs.artifact_path }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            curl \
            git \
            clang \
            lld \
            ca-certificates

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: nightly-2025-08-04
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build locked release
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --locked

      - name: Test binary works (macOS)
        if: runner.os == 'macOS'
        run: |
          output=$(./target/release/mdfried --version)
          echo "Output: $output"
          if [[ "$output" =~ ^mdfried\ [0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "✅ Binary works on macOS - Version: $output"
          else
            echo "❌ Binary test failed! Expected format: 'mdfried x.y.z'"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ./target/release/mdfried

      - name: Install cargo-deb
        if: matrix.build_deb
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-deb

      - name: Build .deb package
        if: matrix.build_deb
        uses: actions-rs/cargo@v1
        with:
          command: deb
          args: --no-build

      - name: Upload .deb artifact
        if: matrix.build_deb
        uses: actions/upload-artifact@v4
        with:
          name: mdfried-deb
          path: ./target/debian/*.deb

  nix-build-windows:
    name: Nix build (windows) ❄️
    runs-on: ubuntu-latest
    outputs:
      artifact_path: ${{ steps.upload-artifact.outputs.artifact_path }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24

      - name: Cachix
        uses: cachix/cachix-action@v12
        with:
          name: mdfried-ci
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Build package
        run: |
          nix build .#windows --print-build-logs

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mdfried-windows
          path: ./result/bin/mdfried.exe
